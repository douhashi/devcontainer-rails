#!/bin/bash

# Docker Compose Productionç’°å¢ƒã‚’ãƒ‡ãƒ¼ãƒ¢ãƒ³ãƒ¢ãƒ¼ãƒ‰ã§èµ·å‹•ã™ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

set -e

# ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å–å¾—
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/../.." && pwd)"

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã«ç§»å‹•
cd "${PROJECT_ROOT}"

# ç’°å¢ƒå¤‰æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒã‚§ãƒƒã‚¯
if [ ! -f ".env.local-prod" ]; then
    echo "âŒ Error: .env.local-prod file not found!"
    echo "Please copy .env.local-prod.sample to .env.local-prod and configure it:"
    echo "  cp .env.local-prod.sample .env.local-prod"
    exit 1
fi

# ãƒãƒ¼ãƒˆè¨­å®š
export EXTERNAL_PORT=18888

echo "ğŸš€ Starting Lofi BGM Production server..."
echo "ğŸ“ Port: ${EXTERNAL_PORT}"
echo "ğŸ“‚ Project root: ${PROJECT_ROOT}"

# Docker Composeã‚’ãƒ‡ãƒ¼ãƒ¢ãƒ³ãƒ¢ãƒ¼ãƒ‰ã§èµ·å‹•
docker compose -f docker-compose.production.yml up -d --build

# èµ·å‹•çŠ¶æ…‹ã‚’ç¢ºèª
echo ""
echo "â³ Waiting for services to be healthy..."
sleep 5

# ã‚³ãƒ³ãƒ†ãƒŠã®çŠ¶æ…‹ã‚’è¡¨ç¤º
docker compose -f docker-compose.production.yml ps

echo ""
echo "âœ… Server started successfully!"
echo "ğŸŒ Access the application at: http://localhost:${EXTERNAL_PORT}"
echo ""
echo "ğŸ“ To view logs:"
echo "  docker compose -f docker-compose.production.yml logs -f"
echo ""
echo "ğŸ›‘ To stop the server:"
echo "  script/server/down"